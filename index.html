<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Innova Space Education</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P64ZZSCZ7Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P64ZZSCZ7Z');
  </script>

  <!-- LibrerÃ­as -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- MathJax: soporta $...$ y $$...$$ -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true
      },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Estilos -->
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg-gradient-to-br from-black via-indigo-900 to-purple-900 text-white font-sans">

  <!-- Barra superior -->
  <header id="auth-bar" class="hidden sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4 py-2 text-sm">
      <div class="opacity-80">Conectado: <span id="user-email" class="font-semibold"></span></div>
      <button id="logout-btn" class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 font-semibold">Salir</button>
    </div>
  </header>

  <!-- Pantalla de autenticaciÃ³n -->
  <section id="auth" class="min-h-[90vh] grid place-items-center px-4">
    <div class="w-full max-w-md bg-gray-900/70 border border-purple-500/50 rounded-2xl p-6 shadow-2xl">
      <h1 class="text-3xl font-extrabold text-center mb-1">Innova Space Education</h1>
      <p id="hero-subtitle" class="text-center text-gray-300 mb-6">Accede con tu correo para usar MIRA</p>

      <h2 id="auth-title" class="text-xl font-bold mb-3">Iniciar sesiÃ³n</h2>

      <form id="auth-form" class="space-y-3">
        <div>
          <label class="block text-sm mb-1" for="email">Correo</label>
          <input id="email" name="email" type="email" required
                 class="w-full p-2 rounded-md bg-gray-800 text-white border border-gray-700"
                 placeholder="tu@correo.com">
        </div>
        <div>
          <label class="block text-sm mb-1" for="password">ContraseÃ±a</label>
          <input id="password" name="password" type="password" required
                 class="w-full p-2 rounded-md bg-gray-800 text-white border border-gray-700"
                 placeholder="********">
        </div>
        <button id="auth-submit" class="w-full py-2 rounded-md bg-purple-600 hover:bg-purple-700 font-bold">Ingresar</button>
        <p id="auth-error" class="text-red-400 text-sm min-h-[1.25rem]"></p>
      </form>

      <div class="mt-4 text-center">
        <button id="toggle-auth" class="text-sm text-purple-300 hover:text-purple-200 underline">
          Â¿No tienes cuenta? Crear una
        </button>
      </div>
    </div>
  </section>

  <!-- App -->
  <main id="landing" class="relative hidden">

    <!-- Dock lateral -->
    <div class="side-dock">
      <!-- Spotify -->
      <button id="btn-spotify" class="dock-btn" title="Spotify">
        <div class="dock-icon">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 2.25A9.75 9.75 0 1 0 21.75 12 9.76 9.76 0 0 0 12 2.25Zm4.35 13.78a.75.75 0 0 1-.97.36 10.27 10.27 0 0 0-6.96-.38.75.75 0 1 1-.48-1.43 11.79 11.79 0 0 1 7.99.45.75.75 0 0 1 .42 1zM17 12.2a.88.88 0 0 1-1.14.43 13.32 13.32 0 0 0-9.09-.5.88.88 0 1 1-.54-1.68 15.06 15.06 0 0 1 10.3.56A.88.88 0 0 1 17 12.2Zm.26-2.72a1 1 0 0 1-1.3.5 16.59 16.59 0 0 0-11.37-.6 1 1 0 0 1-.58-1.9 18.29 18.29 0 0 1 12.55.69 1 1 0 0 1 .7 1.31Z"/>
          </svg>
        </div>
        <span class="dock-label">Spotify</span>
      </button>

      <!-- Usuario / Chats -->
      <button id="btn-user" class="dock-btn" title="Usuario & Chats">
        <div class="dock-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <circle cx="12" cy="8" r="4" stroke-width="1.6"/>
            <path d="M4 20a8 8 0 0 1 16 0" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <span class="dock-label">Usuario</span>
      </button>
    </div>

    <!-- Panel lateral (tabs: MÃºsica / Chats) -->
    <aside id="side-panel" class="side-panel">
      <div class="flex items-center justify-between mb-2">
        <div class="panel-tabs">
          <button class="panel-tab active" data-tab="music">MÃºsica</button>
          <button class="panel-tab" data-tab="chats">Chats</button>
        </div>
        <button id="close-panel" class="close-panel">Cerrar âœ•</button>
      </div>

      <!-- ===== Tab: MÃºsica ===== -->
      <section id="panel-music" class="panel-section active">
        <h3 class="text-lg">MÃºsica para el aprendizaje</h3>
        <div id="playlist-list" class="playlist-list"></div>
        <iframe id="spotify-embed" class="panel-iframe"
          src="" frameborder="0"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"></iframe>
      </section>

      <!-- ===== Tab: Chats / Carpetas ===== -->
      <section id="panel-chats" class="panel-section">
        <div class="chatmgr">
          <div class="mgr-row">
            <button id="btn-new-folder" class="mgr-btn">+ Carpeta</button>
            <button id="btn-new-chat" class="mgr-btn violet">+ Chat</button>
          </div>

          <div class="mgr-columns">
            <!-- Carpetas -->
            <div class="mgr-col">
              <div class="mgr-title">Carpetas</div>
              <ul id="folder-list" class="mgr-list"></ul>
            </div>

            <!-- Chats -->
            <div class="mgr-col">
              <div class="mgr-title">
                Chats <span id="folder-current-name" class="mgr-sub"></span>
              </div>
              <ul id="chat-list" class="mgr-list"></ul>
            </div>
          </div>
        </div>
      </section>
    </aside>

    <!-- Cabecera -->
    <section id="hero" class="text-center">
      <h1 class="hero-title">Innova Space Education</h1>
      <p id="hero-subtitle-app" class="text-lg text-gray-300 mt-3">
        EducaciÃ³n del futuro. Conectando estudiantes con IA.
      </p>
    </section>

    <!-- Chat -->
    <section id="main-chat" class="px-4">
      <div class="chat-wrap max-w-3xl mx-auto relative mt-2 w-full">
        <div class="flex items-center justify-center mb-4 gap-2">
          <h2 class="text-3xl md:text-4xl font-bold text-center m-0">Asistente IA - MIRA</h2>

          <!-- Avatar -->
          <object id="avatar-mira" type="image/svg+xml" data="avatar_mira.svg"
                  class="still" tabindex="-1" aria-hidden="true"></object>
        </div>

        <div id="chat-card" class="bg-gray-900 border border-purple-500 rounded-xl p-4 shadow-xl relative">
          <div id="chat-shell">
            <div id="chat-box" class="bg-gray-800 p-3 rounded-md mb-4 text-sm space-y-2 text-white"></div>

            <div class="input-row flex gap-2">
              <input aria-label="Escribe tu mensaje" type="text" id="user-input"
                     placeholder="Escribe tu mensaje..."
                     class="flex-1 p-2 rounded-md bg-gray-700 text-white border border-gray-600"
                     autocomplete="off"
                     onkeydown="if(event.key==='Enter'){sendMessage();return false;}">
              <button id="send-btn" onclick="sendMessage()"
                      class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-md text-white font-bold" tabindex="0">
                Enviar
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Helpers UI -->
  <script>
    function toggleAreas() {
      const list = document.getElementById("areas-list");
      if (list) list.classList.toggle("hidden");
    }
  </script>

  <!-- LÃ³gica de render auxiliar -->
  <script>
    function addAssistantMessage(text) {
      const chatBox = document.getElementById('chat-box');
      const html = `<div class="msg assistant"><div class="bubble chat-markdown">${marked.parse(text)}</div></div>`;
      chatBox.insertAdjacentHTML('beforeend', html);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (window.MathJax) setTimeout(() => MathJax.typesetPromise(), 60);
    }
  </script>

  <!-- Chat Core -->
  <script src="chat.js"></script>

  <!-- Spotify + Tabs -->
  <script>
    const PLAYLISTS = [
      { id: '4Ldou77MwYfWBV288FirwL', title: 'Electro House mix', description: 'Beats para concentrarte con energÃ­a' },
      { id: '37i9dQZF1DWYY963019MQr', title: 'jazz',                    description: 'Instrumentales suaves para estudiar' },
      { id: '5jQ2Fy8vyfC2mE9oew8c2Q', title: 'Pop mix',                 description: 'Ambientes pop para inspirarte' },
      { id: '2EoheVFjqIxgJMb8VnDRtZ', title: 'K-Pop Hits',              description: 'ClÃ¡sicos modernos del K-Pop' },
      { id: '09yz2h86ElsO8dwbxyplwt', title: 'Classic music',           description: 'Obras clÃ¡sicas para estudiar' },
      { id: '37i9dQZF1EIZna6YqhjeY0', title: 'Calvin Harris',           description: 'Hits y colaboraciones de Calvin Harris' },
      { id: '37i9dQZF1EQmg9rwHdCwFW', title: 'Mix reggaeton',           description: 'ReggaetÃ³n para motivarte' },
      { id: '4hnGrJpcuQepHdewJyUd0w', title: 'Musica relajante naturaleza', description: 'Sonidos de la naturaleza y relax' }
    ];
    let currentPlaylist = PLAYLISTS[0];

    function openPanel(tab='music'){
      document.getElementById('side-panel')?.classList.add('open');
      document.body.classList.toggle('panel-open', true);
      setActiveTab(tab);
    }
    function closePanel(){
      document.getElementById('side-panel')?.classList.remove('open');
      document.body.classList.toggle('panel-open', false);
    }
    function setActiveTab(tab){
      document.querySelectorAll('.panel-tab').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab===tab);
      });
      document.querySelectorAll('.panel-section').forEach(s=>{
        s.classList.remove('active');
      });
      document.getElementById(tab==='music'?'panel-music':'panel-chats').classList.add('active');
    }

    function selectPlaylist(id) {
      const p = PLAYLISTS.find(x => x.id === id);
      if (!p) return;
      currentPlaylist = p;
      document.getElementById('spotify-embed').src =
        `https://open.spotify.com/embed/playlist/${currentPlaylist.id}?utm_source=generator&theme=0`;
      document.querySelectorAll('.playlist-item').forEach(el => {
        el.classList.toggle('active', el.dataset.id === id);
      });
      // halo en el icono
      document.getElementById('btn-spotify')?.classList.add('playing');
    }

    document.addEventListener('DOMContentLoaded', () => {
      // tabs
      document.querySelectorAll('.panel-tab').forEach(b=>{
        b.addEventListener('click', ()=> setActiveTab(b.dataset.tab));
      });

      // playlists
      const list = document.getElementById('playlist-list');
      if (list) {
        PLAYLISTS.forEach(p => {
          const btn = document.createElement('button');
          btn.className = 'playlist-item';
          btn.dataset.id = p.id;
          btn.innerHTML = `<div class="text-sm font-semibold">${p.title}</div>
                           <div class="text-xs opacity-80">${p.description}</div>`;
          btn.addEventListener('click', () => selectPlaylist(p.id));
          list.appendChild(btn);
        });
        selectPlaylist(currentPlaylist.id);
      }

      // dock handlers
      document.getElementById('btn-spotify')?.addEventListener('click', ()=>openPanel('music'));
      document.getElementById('btn-user')?.addEventListener('click', ()=>openPanel('chats'));
      document.getElementById('close-panel')?.addEventListener('click', ()=> {
        closePanel();
        document.getElementById('btn-spotify')?.classList.remove('playing');
      });
    });
  </script>

  <!-- ===================== Firebase (CDN v12.1.0) + Auth + Firestore ===================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
      getDocs, query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCPNds1Tc_BYM5DYroW9-3ZzgeQV1pv0KI",
      authDomain: "innovaspaceai.firebaseapp.com",
      projectId: "innovaspaceai",
      storageBucket: "innovaspaceai.firebasestorage.app",
      messagingSenderId: "488908178763",
      appId: "1:488908178763:web:118fb583571c9934a614ce",
      measurementId: "G-C1RF3TZZ2X"
    };

    const app = initializeApp(firebaseConfig);
    try { if (await isSupported()) getAnalytics(app); } catch (_) {}

    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    // ======= Estado UI =======
    const $authSection = document.getElementById('auth');
    const $landing     = document.getElementById('landing');
    const $authBar     = document.getElementById('auth-bar');
    const $userEmail   = document.getElementById('user-email');
    const $logoutBtn   = document.getElementById('logout-btn');

    const $authTitle   = document.getElementById('auth-title');
    const $authForm    = document.getElementById('auth-form');
    const $authError   = document.getElementById('auth-error');
    const $toggleAuth  = document.getElementById('toggle-auth');
    const $authSubmit  = document.getElementById('auth-submit');

    let mode = 'login';
    function renderMode() {
      if (mode === 'login') {
        $authTitle.textContent = 'Iniciar sesiÃ³n';
        $authSubmit.textContent = 'Ingresar';
        $toggleAuth.textContent = 'Â¿No tienes cuenta? Crear una';
      } else {
        $authTitle.textContent = 'Crear cuenta';
        $authSubmit.textContent = 'Registrarse';
        $toggleAuth.textContent = 'Â¿Ya tienes cuenta? Inicia sesiÃ³n';
      }
      $authError.textContent = '';
    }
    renderMode();
    $toggleAuth.addEventListener('click', () => { mode = (mode==='login')?'register':'login'; renderMode(); });

    $authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      $authError.textContent = '';
      const email = (document.getElementById('email').value || '').trim();
      const password = document.getElementById('password').value;
      try {
        if (mode === 'login') await signInWithEmailAndPassword(auth, email, password);
        else await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        const map = {
          'auth/invalid-email': 'Correo invÃ¡lido.',
          'auth/missing-password': 'Ingresa la contraseÃ±a.',
          'auth/weak-password': 'ContraseÃ±a muy dÃ©bil (min. 6).',
          'auth/email-already-in-use': 'Ese correo ya estÃ¡ registrado.',
          'auth/invalid-credential': 'Correo o contraseÃ±a incorrectos.',
          'auth/operation-not-allowed': 'Habilita Email/Password en Firebase.'
        };
        $authError.textContent = map[err.code] || ('Error: ' + err.message);
      }
    });

    $logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      const logged = !!user;
      $authSection.classList.toggle('hidden', logged);
      $landing.classList.toggle('hidden', !logged);
      $authBar.classList.toggle('hidden', !logged);
      if (logged) {
        $userEmail.textContent = user.email || user.uid;
        ChatStore.init(user.uid);
      } else {
        ChatStore.reset();
      }
    });

    // ================= ChatStore (Firestore) =================
    const folderCol = (uid)=> collection(db, 'users', uid, 'folders');
    const chatCol   = (uid)=> collection(db, 'users', uid, 'chats');
    const msgCol    = (uid, chatId)=> collection(db, 'users', uid, 'chats', chatId, 'messages');

    const $folderList = document.getElementById('folder-list');
    const $chatList   = document.getElementById('chat-list');
    const $folderCurrentName = document.getElementById('folder-current-name');

    const ChatStore = {
      uid: null,
      folders: [], // {id,name}
      chats:   [], // {id,title,folderId,updatedAt}
      currentFolderId: null, // null => "Sin carpeta"
      currentChatId: null,

      reset(){
        this.uid=null; this.folders=[]; this.chats=[];
        this.currentFolderId=null; this.currentChatId=null;
        $folderList.innerHTML=''; $chatList.innerHTML='';
        $folderCurrentName.textContent='';
      },

      async init(uid){
        this.uid = uid;

        // FOLDERS listener
        onSnapshot(query(folderCol(uid), orderBy('name')), snap=>{
          this.folders = snap.docs.map(d=>({id:d.id, ...d.data()}));
          this.renderFolders();
        });

        // CHATS listener
        onSnapshot(query(chatCol(uid), orderBy('updatedAt','desc')), snap=>{
          this.chats = snap.docs.map(d=>({id:d.id, ...d.data()}));
          this.renderChats();
        });

        // Root folder selected by default
        this.setFolder(null);
      },

      // ----- Folders -----
      async newFolder(){
        const name = prompt('Nombre de la carpeta:');
        if (!name) return;
        await addDoc(folderCol(this.uid), { name, createdAt: serverTimestamp() });
      },
      async renameFolder(id){
        const current = this.folders.find(f=>f.id===id);
        const name = prompt('Renombrar carpeta:', current?.name || '');
        if (!name) return;
        await updateDoc(doc(folderCol(this.uid), id), { name });
      },
      async deleteFolder(id){
        const hasChats = this.chats.some(c=>c.folderId===id);
        if (hasChats && !confirm('La carpeta tiene chats. Â¿Mover a â€œSin carpetaâ€ y borrar la carpeta?')) return;
        // mover chats a root
        const affected = this.chats.filter(c=>c.folderId===id);
        await Promise.all(affected.map(c=> updateDoc(doc(chatCol(this.uid), c.id), { folderId: null })));
        await deleteDoc(doc(folderCol(this.uid), id));
        if (this.currentFolderId===id) this.setFolder(null);
      },
      setFolder(id){
        this.currentFolderId = id || null;
        const name = id ? (this.folders.find(f=>f.id===id)?.name || '') : 'Sin carpeta';
        $folderCurrentName.textContent = `Â· ${name}`;
        this.renderFolders(); this.renderChats();
      },

      // ----- Chats -----
      async newChat(){
        const title = prompt('TÃ­tulo del chat:', 'Nuevo chat') || 'Nuevo chat';
        const docRef = await addDoc(chatCol(this.uid), {
          title, folderId: this.currentFolderId || null,
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        this.setChat(docRef.id, true);
      },
      async renameChat(id){
        const current = this.chats.find(c=>c.id===id);
        const title = prompt('Renombrar chat:', current?.title || '');
        if (!title) return;
        await updateDoc(doc(chatCol(this.uid), id), { title, updatedAt: serverTimestamp() });
      },
      async deleteChat(id){
        if (!confirm('Â¿Eliminar chat definitivamente?')) return;
        // borrar mensajes
        const msgs = await getDocs(msgCol(this.uid, id));
        const batch = [];
        msgs.forEach(m=> batch.push(deleteDoc(doc(msgCol(this.uid, id), m.id))));
        await Promise.all(batch);
        await deleteDoc(doc(chatCol(this.uid), id));
        if (this.currentChatId===id) {
          this.currentChatId = null;
          ChatUI.clear();
        }
      },
      async moveChat(id){
        const options = ['(Sin carpeta)', ...this.folders.map(f=>f.name)];
        const idx = prompt(`Mover a carpeta:\n${options.map((n,i)=>`${i}. ${n}`).join('\n')}\nEscribe el nÃºmero:`);
        if (idx===null) return;
        const i = Number(idx);
        if (Number.isNaN(i) || i<0 || i>=options.length) return alert('SelecciÃ³n invÃ¡lida');
        const folderId = i===0 ? null : this.folders[i-1].id;
        await updateDoc(doc(chatCol(this.uid), id), { folderId, updatedAt: serverTimestamp() });
        if (this.currentChatId===id) this.setFolder(folderId);
      },

      async setChat(id, loadHistory=false){
        this.currentChatId = id;
        this.renderChats();
        if (!loadHistory) return;
        // Carga Ãºltimas 50 entradas
        const q = query(msgCol(this.uid, id), orderBy('createdAt','asc'));
        const snap = await getDocs(q);
        ChatUI.clear();
        snap.forEach(docSnap=>{
          const m = docSnap.data();
          ChatUI.add(m.role, m.content);
        });
        if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
      },

      // llamada por chat.js
      async saveMessage(role, content){
        if (!this.uid) return;
        // si no hay chat activo, crear uno con el primer texto del usuario
        if (!this.currentChatId && role==='user') {
          const title = (content || 'Nuevo chat').slice(0, 40);
          const newRef = await addDoc(chatCol(this.uid), {
            title, folderId: this.currentFolderId || null,
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          this.currentChatId = newRef.id;
        }
        if (!this.currentChatId) return;
        await addDoc(msgCol(this.uid, this.currentChatId), {
          role, content, createdAt: serverTimestamp()
        });
        await updateDoc(doc(chatCol(this.uid), this.currentChatId), { updatedAt: serverTimestamp() });
      },

      // ----- Render -----
      renderFolders(){
        const rootActive = this.currentFolderId===null;
        $folderList.innerHTML = `
          <li class="mgr-item ${rootActive?'active':''}">
            <button class="mgr-entry" data-folder="__root">
              ${Icons.folder} <span>Sin carpeta</span>
            </button>
          </li>
        ` + this.folders.map(f=>`
          <li class="mgr-item ${this.currentFolderId===f.id?'active':''}">
            <button class="mgr-entry" data-folder="${f.id}">
              ${Icons.folder} <span>${f.name}</span>
            </button>
            <div class="mgr-actions">
              <button class="mgr-a" data-f-rename="${f.id}" title="Renombrar">âœŽ</button>
              <button class="mgr-a" data-f-del="${f.id}" title="Eliminar">ðŸ—‘</button>
            </div>
          </li>
        `).join('');

        // handlers
        $folderList.querySelectorAll('[data-folder]').forEach(b=>{
          b.onclick = () => this.setFolder(b.dataset.folder==='__root'?null:b.dataset.folder);
        });
        $folderList.querySelectorAll('[data-f-rename]').forEach(b=>{
          b.onclick = ()=> this.renameFolder(b.dataset.fRename);
        });
        $folderList.querySelectorAll('[data-f-del]').forEach(b=>{
          b.onclick = ()=> this.deleteFolder(b.dataset.fDel);
        });
      },

      renderChats(){
        const list = this.chats.filter(c=>(c.folderId||null)===this.currentFolderId);
        $chatList.innerHTML = list.map(c=>`
          <li class="mgr-item ${this.currentChatId===c.id?'active':''}">
            <button class="mgr-entry" data-chat="${c.id}">
              ${Icons.chat} <span>${c.title || 'Chat'}</span>
            </button>
            <div class="mgr-actions">
              <button class="mgr-a" data-c-move="${c.id}"   title="Mover a carpeta">â¤´ï¸Ž</button>
              <button class="mgr-a" data-c-rename="${c.id}" title="Renombrar">âœŽ</button>
              <button class="mgr-a" data-c-del="${c.id}"    title="Eliminar">ðŸ—‘</button>
            </div>
          </li>
        `).join('') || `<li class="text-sm opacity-70 px-2 py-1">No hay chats aquÃ­.</li>`;

        $chatList.querySelectorAll('[data-chat]').forEach(b=>{
          b.onclick = ()=> this.setChat(b.dataset.chat, true);
        });
        $chatList.querySelectorAll('[data-c-rename]').forEach(b=>{
          b.onclick = ()=> this.renameChat(b.dataset.cRename);
        });
        $chatList.querySelectorAll('[data-c-del]').forEach(b=>{
          b.onclick = ()=> this.deleteChat(b.dataset.cDel);
        });
        $chatList.querySelectorAll('[data-c-move]').forEach(b=>{
          b.onclick = ()=> this.moveChat(b.dataset.cMove);
        });
      }
    };

    // UI helpers para el chat-box
    const ChatUI = {
      add(role, content){
        const html = (role==='user')
          ? `<div class="msg user"><div class="bubble chat-markdown">${marked.parse(content)}</div></div>`
          : `<div class="msg assistant"><div class="bubble chat-markdown">${marked.parse(content)}</div></div>`;
        const box = document.getElementById('chat-box');
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
      },
      clear(){
        document.getElementById('chat-box').innerHTML='';
      }
    };

    window.ChatStore = ChatStore; // para chat.js

    // Botones gestor
    document.getElementById('btn-new-folder')?.addEventListener('click', ()=>ChatStore.newFolder());
    document.getElementById('btn-new-chat')?.addEventListener('click',   ()=>ChatStore.newChat());

    // Ajuste 1vh mÃ³vil (corrige barras)
    function setVh(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVh(); window.addEventListener('resize', setVh);
  </script>
  <!-- ======================================================================= -->

</body>
</html>

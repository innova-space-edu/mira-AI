<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Innova Space Education</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P64ZZSCZ7Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P64ZZSCZ7Z');
  </script>

  <!-- Librerías -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']], processEscapes: true },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Altura real del viewport + safe areas -->
  <script>
    function updateViewportVars(){
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
      const top = document.getElementById('auth-bar');
      const h = top && !top.classList.contains('hidden') ? top.offsetHeight : 0;
      document.documentElement.style.setProperty('--topbar-h', h + 'px');
      document.documentElement.style.setProperty('--safe-bottom', 'env(safe-area-inset-bottom, 0px)');
    }
    window.addEventListener('resize', updateViewportVars);
    window.addEventListener('orientationchange', updateViewportVars);
    document.addEventListener('DOMContentLoaded', updateViewportVars);
  </script>

  <!-- Estilos -->
  <link rel="stylesheet" href="style.css"/>
</head>

<body class="bg-gradient-to-br from-black via-indigo-900 to-purple-900 text-white font-sans">

  <!-- Barra superior -->
  <header id="auth-bar" class="hidden sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4 py-2 text-sm">
      <div class="opacity-80">Conectado: <span id="user-email" class="font-semibold"></span></div>
      <button id="logout-btn" class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 font-semibold">Salir</button>
    </div>
  </header>

  <!-- Pantalla de autenticación -->
  <section id="auth" class="grid place-items-center px-4">
    <div class="w-full max-w-md bg-gray-900/70 border border-purple-500/50 rounded-2xl p-6 shadow-2xl auth-card">
      <h1 class="hero-title text-center mb-1">Innova Space Education</h1>
      <p id="hero-subtitle" class="text-center text-gray-300 mb-6">Educación del futuro. Conectando estudiantes con IA.</p>

      <h2 id="auth-title" class="text-xl font-bold mb-3">Iniciar sesión</h2>

      <form id="auth-form" class="space-y-3">
        <div>
          <label class="block text-sm mb-1" for="email">Correo</label>
          <input id="email" name="email" type="email" required class="w-full p-2 rounded-md bg-gray-800 text-white border border-gray-700" placeholder="tu@correo.com">
        </div>
        <div>
          <label class="block text-sm mb-1" for="password">Contraseña</label>
          <input id="password" name="password" type="password" required class="w-full p-2 rounded-md bg-gray-800 text-white border border-gray-700" placeholder="********">
        </div>
        <button id="auth-submit" class="w-full py-2 rounded-md bg-purple-600 hover:bg-purple-700 font-bold">Ingresar</button>
        <p id="auth-error" class="text-red-400 text-sm min-h-[1.25rem]"></p>
      </form>

      <div class="mt-4 text-center">
        <button id="toggle-auth" class="text-sm text-purple-300 hover:text-purple-200 underline">¿No tienes cuenta? Crear una</button>
      </div>
    </div>
  </section>

  <!-- App -->
  <main id="landing" class="relative hidden">

    <!-- Título centrado (animado) -->
    <div class="hero-bar">
      <h1 class="site-title-centered">Innova Space Education</h1>
    </div>

    <!-- Cabecera del asistente (avatar debajo de “IA”) -->
    <div id="assistant-header">
      <h2 class="assistant-name">
        Asistente
        <span class="ia-with-avatar"> IA
          <object id="avatar-mira" type="image/svg+xml" data="avatar_mira.svg" class="still" tabindex="-1"></object>
        </span>
        – <span class="mira">MIRA</span>
      </h2>
    </div>

    <!-- Dock lateral -->
    <div class="side-dock">
      <button id="btn-spotify" class="dock-btn" title="Spotify">
        <span class="dock-icon">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><linearGradient id="g" x1="2" y1="2" x2="22" y2="22"><stop stop-color="#22c55e"/><stop offset="1" stop-color="#a855f7"/></linearGradient></defs>
            <path d="M12 2.25C6.615 2.25 2.25 6.615 2.25 12S6.615 21.75 12 21.75 21.75 17.385 21.75 12 17.385 2.25 12 2.25Z" fill="url(#g)"/>
            <path d="M7.7 15.55c3.1-1.87 7.02-.99 8.92 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".9"/>
            <path d="M7.3 13.08c3.7-2.1 7.9-1.1 10 .1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".8"/>
            <path d="M7.05 10.5c4.35-2.4 9.7-1.3 12.2.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".7"/>
          </svg>
        </span>
        <span class="dock-label">Spotify</span>
      </button>

      <button id="btn-user" class="dock-btn" title="Usuario">
        <span class="dock-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="7" r="4"/>
          </svg>
        </span>
        <span class="dock-label">Usuario</span>
      </button>

      <!-- NUEVO: Configuración -->
      <button id="btn-settings" class="dock-btn" title="Configuración">
        <span class="dock-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.07a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15a1.65 1.65 0 0 0-1.51-1H3.4a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 5 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 3.4V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19 9c0 .6.23 1.18.64 1.6.42.41 1 .64 1.6.64h.36a2 2 0 1 1 0 4h-.36c-.6 0-1.18.23-1.6.64Z" stroke-width="1.2"/>
          </svg>
        </span>
        <span class="dock-label">Configuración</span>
      </button>
    </div>

    <!-- Panel lateral -->
    <aside id="side-panel" class="side-panel" data-mode="music">
      <div class="flex items-center justify-between mb-2">
        <h3 id="panel-title" class="text-lg">Música para el aprendizaje</h3>
        <button id="close-panel" class="close-panel">Cerrar ✕</button>
      </div>

      <!-- Música -->
      <div id="panel-music" class="panel-section active">
        <div id="playlist-list" class="playlist-list"></div>
        <iframe id="spotify-embed" class="panel-iframe" src="" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      </div>

      <!-- Tus chats -->
      <div id="panel-chats" class="panel-section">
        <div class="text-sm opacity-80 mb-2">Conectado como <span id="panel-user-email"></span></div>

        <div class="flex gap-2 mb-3">
          <button id="btn-new-chat" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded">Nuevo chat</button>
          <button id="btn-logout-panel" class="bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded">Cerrar sesión</button>
        </div>

        <div class="panel-chats-header">
          <div class="text-sm opacity-70">Tus chats</div>
          <button id="btn-clear-all-chats" class="clear-all-btn" title="Eliminar todos los chats">Eliminar todos</button>
        </div>

        <div id="chat-list" class="playlist-list" style="max-height:48vh; overflow:auto;"></div>
      </div>

      <!-- Configuración -->
      <div id="panel-settings" class="panel-section">
        <div class="text-sm opacity-80 mb-2">Tema de la app</div>
        <div class="palette-grid">
          <button class="palette-btn" data-theme="gray">
            <span class="swatch sw1"></span><span class="swatch sw2"></span><span class="swatch sw3"></span>
            <span class="label">Escala de grises</span>
          </button>
          <button class="palette-btn" data-theme="blue">
            <span class="swatch sw1 blue"></span><span class="swatch sw2 blue"></span><span class="swatch sw3 blue"></span>
            <span class="label">Escala de azul</span>
          </button>
          <button class="palette-btn" data-theme="red">
            <span class="swatch sw1 red"></span><span class="swatch sw2 red"></span><span class="swatch sw3 red"></span>
            <span class="label">Escala de rojo</span>
          </button>
        </div>
        <div class="text-xs opacity-70 mt-2">Se guarda automáticamente.</div>
      </div>

      <!-- Modal acciones de chat -->
      <div id="chat-actions-modal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="cam-title">
          <div class="modal-header">
            <div id="cam-title" class="modal-title">Acciones del chat</div>
            <button id="cam-close" class="modal-close" aria-label="Cerrar">✕</button>
          </div>
          <div class="modal-body">
            <div class="modal-chat-title" id="cam-chat-title">—</div>
            <div class="modal-actions">
              <button id="cam-open"   class="modal-btn primary">Abrir</button>
              <button id="cam-rename" class="modal-btn">Renombrar</button>
              <button id="cam-delete" class="modal-btn danger">Eliminar</button>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Chat -->
    <section id="main-chat" class="px-4">
      <div class="chat-wrap max-w-3xl mx-auto relative mt-2 w-full">
        <div id="chat-card" class="bg-gray-900 border border-purple-500 rounded-xl p-4 shadow-xl relative">
          <div id="chat-shell">
            <div id="chat-box" class="bg-gray-800 p-3 rounded-md mb-2 text-sm space-y-2 text-white"></div>

            <!-- Composer -->
            <div class="composer">
              <div class="input-group">
                <input aria-label="Escribe tu mensaje"
                       type="text"
                       id="user-input"
                       placeholder="Escribe tu mensaje..."
                       class="composer-input"
                       autocomplete="off"/>

                <!-- Micrófono dentro del input -->
                <button id="btn-mic" class="mic-btn" title="Dictar por voz" aria-label="Dictar por voz">
                  <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zM5 11a1 1 0 1 0-2 0 9 9 0 0 0 8 8v3h2v-3a9 9 0 0 0 8-8 1 1 0 1 0-2 0 7 7 0 0 1-14 0z"/>
                  </svg>
                </button>

                <!-- Botón + flotante -->
                <button id="attachBtn" class="plus-btn" title="Adjuntar" aria-haspopup="true" aria-controls="attachMenu" aria-expanded="false">+</button>

                <!-- Menú del + -->
                <div id="attachMenu" class="upload-tray hidden" role="menu">
                  <button id="attachImageOption" class="upload-item" role="menuitem">📎 Adjuntar imagen</button>
                </div>

                <!-- Input de archivos (oculto) -->
                <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp" multiple hidden>
              </div>

              <!-- Enviar pequeño a la derecha -->
              <button id="send-btn" class="send-btn">Enviar</button>
            </div>

            <!-- Previews -->
            <div id="attachments" class="attachments" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Panel / Playlists + microinteracciones -->
  <script>
    const PLAYLISTS = [
      { id:'4Ldou77MwYfWBV288FirwL', title:'Electro House mix',       description:'Beats para concentrarte con energía' },
      { id:'37i9dQZF1DWYY963019MQr', title:'jazz',                    description:'Instrumentales suaves para estudiar' },
      { id:'5jQ2Fy8vyfC2mE9oew8c2Q', title:'Pop mix',                 description:'Ambientes pop para inspirarte' },
      { id:'2EoheVFjqIxgJMb8VnDRtZ', title:'K-Pop Hits',              description:'Clásicos modernos del K-Pop' },
      { id:'09yz2h86ElsO8dwbxyplwt', title:'Classic music',           description:'Obras clásicas para estudiar' },
      { id:'37i9dQZF1EIZna6YqhjeY0', title:'Calvin Harris',           description:'Hits y colaboraciones de Calvin Harris' },
      { id:'37i9dQZF1EQmg9rwHdCwFW', title:'Mix reggaeton',           description:'Reggaetón para motivarte' },
      { id:'4hnGrJpcuQepHdewJyUd0w', title:'Musica relajante naturaleza', description:'Sonidos de la naturaleza y relax' }
    ];
    let currentPlaylist = PLAYLISTS[0];

    const panel    = document.getElementById('side-panel');
    const titleEl  = document.getElementById('panel-title');
    const secMusic = document.getElementById('panel-music');
    const secChats = document.getElementById('panel-chats');

    function setPanelMode(mode){
      const isMusic    = (mode === 'music');
      const isChats    = (mode === 'chats');
      const isSettings = (mode === 'settings');

      secMusic.classList.toggle('active', isMusic);
      secChats.classList.toggle('active', isChats);
      document.getElementById('panel-settings').classList.toggle('active', isSettings);

      titleEl.textContent = isMusic ? 'Música para el aprendizaje' : (isChats ? 'Tus chats' : 'Configuración');
      panel.classList.add('open');
      document.body.classList.add('panel-open');
      const u = window._currentUser;
      if (u) document.getElementById('panel-user-email').textContent = u.email || u.uid;
      updateViewportVars();
    }
    function closePanel(){ panel.classList.remove('open'); document.body.classList.remove('panel-open'); }
    function selectPlaylist(id) {
      const p = PLAYLISTS.find(x => x.id === id); if (!p) return;
      currentPlaylist = p;
      document.getElementById('spotify-embed').src = `https://open.spotify.com/embed/playlist/${currentPlaylist.id}?utm_source=generator&theme=0`;
      document.querySelectorAll('.playlist-item').forEach(el => el.classList.toggle('active', el.dataset.id === id));
      document.getElementById('btn-spotify')?.classList.add('playing');
    }
    document.getElementById('btn-spotify')?.addEventListener('click', ()=>setPanelMode('music'));
    document.getElementById('btn-user')?.addEventListener('click',   ()=>setPanelMode('chats'));
    document.getElementById('btn-settings')?.addEventListener('click', ()=>setPanelMode('settings'));
    document.getElementById('close-panel')?.addEventListener('click', closePanel);

    document.addEventListener('DOMContentLoaded', () => {
      // Playlists
      const list = document.getElementById('playlist-list');
      if (list) {
        PLAYLISTS.forEach(p => {
          const btn = document.createElement('button');
          btn.className = 'playlist-item';
          btn.dataset.id = p.id;
          btn.innerHTML = `<div class="text-sm font-semibold">${p.title}</div><div class="text-xs opacity-80">${p.description}</div>`;
          btn.addEventListener('click', () => selectPlaylist(p.id));
          list.appendChild(btn);
        });
        selectPlaylist(currentPlaylist.id);
      }

      // Asegurar visibilidad del input en móviles
      const inp = document.getElementById('user-input');
      if (inp) {
        const ensureVisible = () => setTimeout(()=> inp.scrollIntoView({ block:'nearest', behavior:'smooth' }), 120);
        inp.addEventListener('focus', ensureVisible);
      }

      // ===== Micro-interacciones =====
      const attachBtn  = document.getElementById('attachBtn');
      const attachMenu = document.getElementById('attachMenu');
      const sendBtn    = document.getElementById('send-btn');

      // Toggle del menú de adjuntar (+ rota a × con CSS via aria-expanded)
      attachBtn?.addEventListener('click', (e)=>{
        e.stopPropagation();
        const isOpen = attachBtn.getAttribute('aria-expanded') === 'true';
        attachBtn.setAttribute('aria-expanded', String(!isOpen));
        attachMenu.classList.toggle('hidden', isOpen);
      });
      document.addEventListener('click', (e)=>{
        if (!attachMenu.contains(e.target) && e.target !== attachBtn){
          attachMenu.classList.add('hidden');
          attachBtn.setAttribute('aria-expanded','false');
        }
      });

      // Ripple en enviar
      sendBtn?.addEventListener('click', (e)=>{
        const r = sendBtn.getBoundingClientRect();
        const x = e.clientX - r.left;
        const y = e.clientY - r.top;
        sendBtn.style.setProperty('--ripple-x', x + 'px');
        sendBtn.style.setProperty('--ripple-y', y + 'px');
        sendBtn.classList.remove('do-ripple');
        void sendBtn.offsetWidth;
        sendBtn.classList.add('do-ripple');
      });

      // ===== Temas (Configuración) – con animación =====
      (function initThemes(){
        const KEY = 'mira_theme';
        const root = document.body;

        const applyTheme = (t, animate=true)=>{
          root.classList.remove('theme-gray','theme-blue','theme-red');
          root.classList.add('theme-' + t);
          if (animate){
            root.classList.add('theme-anim');
            setTimeout(()=> root.classList.remove('theme-anim'), 900);
          }
          document.querySelectorAll('.palette-btn').forEach(b=>{
            b.classList.toggle('active', b.dataset.theme === t);
          });
        };

        const saved = localStorage.getItem(KEY) || 'blue';
        applyTheme(saved, false);

        document.querySelectorAll('.palette-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const t = btn.dataset.theme;
            localStorage.setItem(KEY, t);
            applyTheme(t, true);
          });
        });
      })();
    });
  </script>

  <!-- ================= Firebase (módulo) + Auth + Firestore ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCPNds1Tc_BYM5DYroW9-3ZzgeQV1pv0KI",
      authDomain: "innovaspaceai.firebaseapp.com",
      projectId: "innovaspaceai",
      storageBucket: "innovaspaceai.firebasestorage.app",
      messagingSenderId: "488908178763",
      appId: "1:488908178763:web:118fb583571c9934a614ce",
      measurementId: "G-C1RF3TZZ2X"
    };

    const app = initializeApp(firebaseConfig);
    try { if (await isSupported()) getAnalytics(app); } catch(_) {}
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    window.ChatStore = (function(){
      let currentChatId = null;
      let currentUser   = null;

      function userChatsCol(uid){ return collection(db, 'users', uid, 'chats'); }
      function chatDocRef(uid, chatId){ return doc(db, 'users', uid, 'chats', chatId); }
      function setUser(u){ currentUser = u || null; window._currentUser = currentUser; if(!u) currentChatId = null; }

      async function ensureChat(){
        if (currentChatId) return currentChatId;
        if (!currentUser) {
          currentChatId = "guest-" + Date.now();
          const all = getGuestAll();
          all.push({ id: currentChatId, title:"Nuevo chat", messages:[], createdAt:Date.now(), updatedAt:Date.now() });
          localStorage.setItem('mira_guest_chats', JSON.stringify(all));
          await loadChatList(); return currentChatId;
        }
        const ref = await addDoc(userChatsCol(currentUser.uid), { title: "Nuevo chat", createdAt: serverTimestamp(), updatedAt: serverTimestamp(), messages: [] });
        currentChatId = ref.id; await loadChatList(); return currentChatId;
      }

      async function saveMessage(role, content){
        const id = await ensureChat();
        if (!currentUser){
          const all = getGuestAll();
          const chat = all.find(c=>c.id===id);
          chat.messages.push({ role, content, ts: Date.now() });
          chat.updatedAt = Date.now();
          if (role==="user" && chat.title==="Nuevo chat") chat.title = content.slice(0,40);
          localStorage.setItem('mira_guest_chats', JSON.stringify(all));
          return;
        }
        const ref = chatDocRef(currentUser.uid, id);
        await setDoc(ref, { updatedAt: serverTimestamp(), ...(role === "user" ? { title: content.slice(0,40) } : {} ), messages: arrayUnion({ role, content, ts: Date.now() }) }, { merge: true });
      }

      async function renameChat(id, newTitle){
        if (!id || !newTitle) return;
        if (!currentUser){
          const all = getGuestAll();
          const chat = all.find(c=>c.id===id); if (chat){ chat.title = newTitle; chat.updatedAt = Date.now(); localStorage.setItem('mira_guest_chats', JSON.stringify(all)); await loadChatList(); }
          return;
        }
        await updateDoc(chatDocRef(currentUser.uid, id), { title: newTitle, updatedAt: serverTimestamp() });
        await loadChatList();
      }

      async function deleteChat(id){
        if (!id) return;
        if (!currentUser){
          const all = getGuestAll().filter(c=>c.id!==id);
          localStorage.setItem('mira_guest_chats', JSON.stringify(all));
          if (currentChatId === id) currentChatId = null;
          await loadChatList();
          return;
        }
        await deleteDoc(chatDocRef(currentUser.uid, id));
        if (currentChatId === id) currentChatId = null;
        await loadChatList();
      }

      // Eliminar todos los chats
      async function deleteAllChats(){
        if (!confirm('¿Eliminar TODOS los chats? Esta acción no se puede deshacer.')) return;

        if (!currentUser){
          localStorage.setItem('mira_guest_chats', JSON.stringify([]));
          currentChatId = null;
          await loadChatList();
          return;
        }
        const qy = query(userChatsCol(currentUser.uid), orderBy('updatedAt','desc'));
        const snap = await getDocs(qy);
        for (const d of snap.docs) { await deleteDoc(d.ref); }
        currentChatId = null;
        await loadChatList();
      }

      // Render lista con botón ⋯ que abre MODAL con acciones
      async function loadChatList(){
        const list = document.getElementById('chat-list'); if (!list) return;
        list.innerHTML = "";

        const addRow = (id, title) => {
          const row = document.createElement('div');
          row.className = 'chat-item';
          row.dataset.id = id;
          row.innerHTML = `
            <div class="chat-main">
              <span class="chat-title">${(title || "Chat")}</span>
              <button class="kebab-btn" title="Más acciones">⋯</button>
            </div>`;
          // abrir modal
          row.querySelector('.kebab-btn').addEventListener('click', (e)=>{
            e.stopPropagation();
            openChatActionsModal(id, title || "Chat");
          });
          list.appendChild(row);
        };

        if (!currentUser){
          getGuestAll().sort((a,b)=>b.updatedAt-a.updatedAt).forEach(c=> addRow(c.id, c.title));
        } else {
          const qy = query(userChatsCol(currentUser.uid), orderBy('updatedAt','desc'));
          const snap = await getDocs(qy);
          snap.forEach(docSnap=> addRow(docSnap.id, (docSnap.data().title || "Chat")));
        }

        // clic en título = abrir chat
        list.onclick = async (e) => {
          const titleEl = e.target.closest('.chat-title');
          if (titleEl) {
            const item = titleEl.closest('.chat-item');
            await loadChat(item.dataset.id);
          }
        };
      }

      // Modal de acciones
      function openChatActionsModal(id, title){
        const modal = document.getElementById('chat-actions-modal');
        if (!modal) return;
        modal.classList.remove('hidden');
        modal.dataset.chatId = id;

        const t = modal.querySelector('#cam-chat-title');
        if (t) t.textContent = title;

        const close = ()=> modal.classList.add('hidden');

        modal.querySelector('#cam-close')?.addEventListener('click', close, { once:true });
        modal.querySelector('.modal-backdrop')?.addEventListener('click', close, { once:true });

        modal.querySelector('#cam-open')?.addEventListener('click', async ()=>{
          await loadChat(id); close();
        }, { once:true });

        modal.querySelector('#cam-rename')?.addEventListener('click', async ()=>{
          const current = title;
          const nuevo = prompt('Nuevo nombre del chat:', current);
          if (nuevo && nuevo.trim()) await renameChat(id, nuevo.trim());
          close();
        }, { once:true });

        modal.querySelector('#cam-delete')?.addEventListener('click', async ()=>{
          if (confirm('¿Eliminar este chat?')) await deleteChat(id);
          close();
        }, { once:true });
      }

      async function loadChat(chatId){
        currentChatId = chatId;
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = "";
        if(!currentUser){
          const c = getGuestAll().find(x=>x.id===chatId);
          (c?.messages||[]).forEach(m=>{
            const html = (typeof marked!=="undefined")? marked.parse(m.content) : m.content;
            const div = document.createElement("div");
            div.className = "msg " + (m.role === "user" ? "user" : "assistant");
            div.innerHTML = `<div class="bubble chat-markdown">${html}</div>`;
            chatBox.appendChild(div);
          });
          if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
          document.getElementById('side-panel')?.classList.remove('open');
          document.body.classList.remove('panel-open');
          return;
        }
        const ref = chatDocRef(currentUser.uid, chatId);
        const snap = await getDoc(ref);
        (snap.data()?.messages||[]).forEach(m=>{
          const html = (typeof marked!=="undefined")? marked.parse(m.content) : m.content;
          const div = document.createElement("div");
          div.className = "msg " + (m.role === "user" ? "user" : "assistant");
          div.innerHTML = `<div class="bubble chat-markdown">${html}</div>`;
          chatBox.appendChild(div);
        });
        if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
        document.getElementById('side-panel')?.classList.remove('open');
        document.body.classList.remove('panel-open');
      }

      function newChat(){
        currentChatId = null;
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = "";
        const saludo = "¡Nuevo chat iniciado! ¿Sobre qué tema quieres conversar?";
        const html = (typeof marked!=="undefined")? marked.parse(saludo) : saludo;
        const div = document.createElement("div");
        div.className = "msg assistant";
        div.innerHTML = `<div class="bubble chat-markdown">${html}</div>`;
        chatBox.appendChild(div);
        document.getElementById('side-panel')?.classList.remove('open');
        document.body.classList.remove('panel-open');
      }

      function getGuestAll(){ try{ return JSON.parse(localStorage.getItem('mira_guest_chats')||"[]"); }catch{ return []; } }

      return { setUser, saveMessage, loadChatList, loadChat, newChat, renameChat, deleteChat, deleteAllChats };
    })();

    const $authSection = document.getElementById('auth');
    const $landing     = document.getElementById('landing');
    const $authBar     = document.getElementById('auth-bar');
    const $userEmail   = document.getElementById('user-email');
    const $panelUser   = document.getElementById('panel-user-email');
    const $logoutTop   = document.getElementById('logout-btn');
    const $logoutPanel = document.getElementById('btn-logout-panel');

    const $authTitle  = document.getElementById('auth-title');
    const $authForm   = document.getElementById('auth-form');
    const $authError  = document.getElementById('auth-error');
    const $toggleAuth = document.getElementById('toggle-auth');
    const $authSubmit = document.getElementById('auth-submit');

    let mode = 'login';
    function renderMode(){
      if (mode === 'login') { $authTitle.textContent = 'Iniciar sesión'; $authSubmit.textContent = 'Ingresar'; $toggleAuth.textContent = '¿No tienes cuenta? Crear una'; }
      else { $authTitle.textContent = 'Crear cuenta'; $authSubmit.textContent = 'Registrarse'; $toggleAuth.textContent = '¿Ya tienes cuenta? Inicia sesión'; }
      $authError.textContent = '';
    }
    renderMode();

    $toggleAuth.addEventListener('click', ()=>{ mode = (mode==='login'?'register':'login'); renderMode(); });

    $authForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      $authError.textContent = '';
      const email = (document.getElementById('email').value || '').trim();
      const password = document.getElementById('password').value;
      try{
        if (mode === 'login') await signInWithEmailAndPassword(auth, email, password);
        else await createUserWithEmailAndPassword(auth, email, password);
      }catch(err){
        const map = {
          'auth/invalid-email': 'Correo inválido.',
          'auth/missing-password': 'Ingresa la contraseña.',
          'auth/weak-password': 'Contraseña muy débil (min. 6).',
          'auth/email-already-in-use': 'Ese correo ya está registrado.',
          'auth/invalid-credential': 'Correo o contraseña incorrectos.',
          'auth/operation-not-allowed': 'Habilita Email/Password en Firebase.'
        };
        $authError.textContent = map[err.code] || ('Error: ' + err.message);
      }
    });

    $logoutTop?.addEventListener('click', ()=>signOut(auth));
    $logoutPanel?.addEventListener('click', ()=>signOut(auth));

    document.getElementById('btn-new-chat')?.addEventListener('click', ()=>window.ChatStore.newChat());
    document.getElementById('btn-clear-all-chats')?.addEventListener('click', ()=>window.ChatStore.deleteAllChats());

    onAuthStateChanged(auth, async (user)=>{
      window.ChatStore.setUser(user || null);
      window._currentUser = user || null;

      const logged = !!user;
      $authSection.classList.toggle('hidden', logged);
      $landing.classList.toggle('hidden', !logged);
      $authBar.classList.toggle('hidden', !logged);

      updateViewportVars();

      if (logged){
        const email = user.email || user.uid;
        $userEmail.textContent = email;
        if ($panelUser) $panelUser.textContent = email;
        await window.ChatStore.loadChatList();
        document.getElementById('side-panel')?.classList.remove('open');
        document.body.classList.remove('panel-open');
      }
    });
  </script>

  <!-- Lógica del chat -->
  <script src="chat.js"></script>
</body>
</html>

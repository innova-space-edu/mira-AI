<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Innova Space Education</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P64ZZSCZ7Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-P64ZZSCZ7Z');
  </script>

  <!-- Librerías -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Configuración MathJax: soporta $...$ inline y $$...$$ display -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true
      },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg-gradient-to-br from-black via-indigo-900 to-purple-900 text-white font-sans">

  <!-- Barra superior con usuario + salir (solo cuando hay sesión) -->
  <header id="auth-bar" class="hidden sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4 py-2 text-sm">
      <div class="opacity-80">Conectado: <span id="user-email" class="font-semibold"></span></div>
      <button id="logout-btn" class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 font-semibold">Salir</button>
    </div>
  </header>

  <!-- Pantalla de autenticación -->
  <section id="auth" class="min-h-[90vh] grid place-items-center px-4">
    <div class="w-full max-w-md bg-gray-900/70 border border-purple-500/50 rounded-2xl p-6 shadow-2xl">
      <h1 class="text-3xl font-extrabold text-center mb-1">Innova Space Education</h1>
      <p class="text-center text-gray-300 mb-6">Accede con tu correo para usar MIRA</p>

      <h2 id="auth-title" class="text-xl font-bold mb-3">Iniciar sesión</h2>

      <form id="auth-form" class="space-y-3">
        <div>
          <label class="block text-sm mb-1" for="email">Correo</label>
          <input id="email" name="email" type="email" required
                 class="w-full p-2 rounded-md bg-gray-800 text-white border border-gray-700"
                 placeholder="tu@correo.com">
        </div>
        <div>
          <label class="block text-sm mb-1" for="password">Contraseña</label>
          <input id="password" name="password" type="password" required
                 class="w-full p-2 rounded-md bg-gray-800 text-white border border-gray-700"
                 placeholder="********">
        </div>
        <button id="auth-submit" class="w-full py-2 rounded-md bg-purple-600 hover:bg-purple-700 font-bold">Ingresar</button>
        <p id="auth-error" class="text-red-400 text-sm min-h-[1.25rem]"></p>
      </form>

      <div class="mt-4 text-center">
        <button id="toggle-auth" class="text-sm text-purple-300 hover:text-purple-200 underline">
          ¿No tienes cuenta? Crear una
        </button>
      </div>
    </div>
  </section>

  <!-- App (se muestra solo cuando hay sesión) -->
  <main id="landing" class="relative hidden">

    <!-- Barra lateral: botón Spotify más grande con etiqueta -->
    <div class="side-dock">
      <button id="btn-spotify" class="dock-btn" title="Spotify">
        <!-- Ícono -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="2" y1="2" x2="22" y2="22">
              <stop stop-color="#22c55e"/><stop offset="1" stop-color="#a855f7"/>
            </linearGradient>
          </defs>
          <path d="M12 2.25C6.615 2.25 2.25 6.615 2.25 12S6.615 21.75 12 21.75 21.75 17.385 21.75 12 17.385 2.25 12 2.25Z" fill="url(#g)"/>
          <path d="M7.7 15.55c3.1-1.87 7.02-.99 8.92 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".9"/>
          <path d="M7.3 13.08c3.7-2.1 7.9-1.1 10 .1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".8"/>
          <path d="M7.05 10.5c4.35-2.4 9.7-1.3 12.2.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".7"/>
        </svg>
        <span class="dock-label">Spotify</span>
      </button>
    </div>

    <!-- Panel lateral Spotify -->
    <aside id="music-panel" class="side-panel">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg">Música para el aprendizaje</h3>
        <button id="close-panel" class="close-panel">Cerrar ✕</button>
      </div>

      <div id="playlist-list" class="playlist-list"></div>

      <iframe id="spotify-embed" class="panel-iframe"
        src="" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy">
      </iframe>
    </aside>

    <!-- Cabecera -->
    <section id="hero" class="text-center">
      <h1 class="text-5xl md:text-6xl font-extrabold bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 text-transparent bg-clip-text">
        Innova Space Education
      </h1>
      <p class="text-lg text-gray-300 mt-3">Educación del futuro. Conectando estudiantes con IA.</p>
    </section>

    <!-- Chat -->
    <section id="main-chat" class="px-4">
      <div class="chat-wrap max-w-3xl mx-auto relative mt-2 w-full">
        <div class="flex items-center justify-center mb-4 gap-2">
          <h2 class="text-3xl md:text-4xl font-bold text-center m-0">Asistente IA - MIRA</h2>

          <!-- Avatar separado -->
          <object
            id="avatar-mira"
            type="image/svg+xml"
            data="avatar_mira.svg"
            class="still"
            tabindex="-1"
            aria-hidden="true">
          </object>
        </div>

        <div id="chat-card" class="bg-gray-900 border border-purple-500 rounded-xl p-4 shadow-xl relative">
          <div id="chat-shell">
            <!-- Vacío: el saludo se inyecta por JS como burbuja -->
            <div id="chat-box" class="bg-gray-800 p-3 rounded-md mb-4 text-sm space-y-2 text-white"></div>

            <div class="flex gap-2">
              <input
                aria-label="Escribe tu mensaje"
                type="text" id="user-input"
                placeholder="Escribe tu mensaje..."
                class="flex-1 p-2 rounded-md bg-gray-700 text-white border border-gray-600"
                autocomplete="off"
                onkeydown="if(event.key==='Enter'){sendMessage();return false;}">
              <button id="send-btn" onclick="sendMessage()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-md text-white font-bold" tabindex="0">
                Enviar
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Helpers UI básicos -->
  <script>
    function toggleMiraInfo() {
      const info = document.getElementById("mira-info");
      if (!info) return;
      info.style.display = (info.style.display === "none" || info.style.display === "") ? "block" : "none";
    }
    function toggleAreas() {
      const list = document.getElementById("areas-list");
      if (list) list.classList.toggle("hidden");
    }
  </script>

  <!-- Chat logic -->
  <script src="chat.js"></script>

  <!-- Markdown + LaTeX helper (sigue) -->
  <script>
    function addAssistantMessage(text) {
      const chatBox = document.getElementById('chat-box');
      const html = `<div class="msg assistant"><div class="bubble chat-markdown">${marked.parse(text)}</div></div>`;
      chatBox.insertAdjacentHTML('beforeend', html);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (window.MathJax) setTimeout(() => MathJax.typesetPromise(), 60);
    }
  </script>

  <!-- Spotify panel -->
  <script>
    // Playlists (con tus títulos pedidos)
    const PLAYLISTS = [
      // renombradas
      { id: '4Ldou77MwYfWBV288FirwL', title: 'Electro House mix',       description: 'Beats para concentrarte con energía' },
      { id: '37i9dQZF1DWYY963019MQr', title: 'jazz',                    description: 'Instrumentales suaves para estudiar' },
      { id: '5jQ2Fy8vyfC2mE9oew8c2Q', title: 'Pop mix',                 description: 'Ambientes pop para inspirarte' },
      { id: '2EoheVFjqIxgJMb8VnDRtZ', title: 'K-Pop Hits',              description: 'Clásicos modernos del K-Pop' },

      // nuevas
      { id: '09yz2h86ElsO8dwbxyplwt', title: 'Classic music',             description: 'Obras clásicas para estudiar' },
      { id: '37i9dQZF1EIZna6YqhjeY0', title: 'Calvin Harris',             description: 'Hits y colaboraciones de Calvin Harris' },
      { id: '37i9dQZF1EQmg9rwHdCwFW', title: 'Mix reggaeton',             description: 'Reggaetón para motivarte' },
      { id: '4hnGrJpcuQepHdewJyUd0w', title: 'Musica relajante naturaleza', description: 'Sonidos de la naturaleza y relax' }
    ];

    let currentPlaylist = PLAYLISTS[0]; // inicia con Electro House mix

    function toggleMusicPanel() {
      const panel = document.getElementById('music-panel');
      panel?.classList.toggle('open');
      document.body.classList.toggle('panel-open', panel.classList.contains('open'));
    }

    function selectPlaylist(id) {
      const p = PLAYLISTS.find(x => x.id === id);
      if (!p) return;
      currentPlaylist = p;
      document.getElementById('spotify-embed').src =
        `https://open.spotify.com/embed/playlist/${currentPlaylist.id}?utm_source=generator&theme=0`;
      document.querySelectorAll('.playlist-item').forEach(el => {
        el.classList.toggle('active', el.dataset.id === id);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const list = document.getElementById('playlist-list');
      if (list) {
        PLAYLISTS.forEach(p => {
          const btn = document.createElement('button');
          btn.className = 'playlist-item';
          btn.dataset.id = p.id;
          btn.innerHTML = `
            <div class="text-sm font-semibold">${p.title}</div>
            <div class="text-xs opacity-80">${p.description}</div>`;
          btn.addEventListener('click', () => selectPlaylist(p.id));
          list.appendChild(btn);
        });
      }
      selectPlaylist(currentPlaylist.id);

      document.getElementById('btn-spotify')?.addEventListener('click', toggleMusicPanel);
      document.getElementById('close-panel')?.addEventListener('click', toggleMusicPanel);
    });
  </script>

  <!-- ===================== Firebase (CDN v12.1.0) + Auth ===================== -->
  <script type="module">
    // Importa SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

    // Config de tu proyecto (pública)
    const firebaseConfig = {
      apiKey: "AIzaSyCPNds1Tc_BYM5DYroW9-3ZzgeQV1pv0KI",
      authDomain: "innovaspaceai.firebaseapp.com",
      projectId: "innovaspaceai",
      storageBucket: "innovaspaceai.firebasestorage.app",
      messagingSenderId: "488908178763",
      appId: "1:488908178763:web:118fb583571c9934a614ce",
      measurementId: "G-C1RF3TZZ2X"
    };

    // Inicializa
    const app = initializeApp(firebaseConfig);
    try { if (await isSupported()) getAnalytics(app); } catch (_) {}

    // Auth + persistencia "siempre"
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);

    // --- UI / DOM ---
    const $authSection = document.getElementById('auth');
    const $landing     = document.getElementById('landing');
    const $authBar     = document.getElementById('auth-bar');
    const $userEmail   = document.getElementById('user-email');
    const $logoutBtn   = document.getElementById('logout-btn');

    const $authTitle   = document.getElementById('auth-title');
    const $authForm    = document.getElementById('auth-form');
    const $authError   = document.getElementById('auth-error');
    const $toggleAuth  = document.getElementById('toggle-auth');
    const $authSubmit  = document.getElementById('auth-submit');

    let mode = 'login'; // 'login' | 'register'
    function renderMode() {
      if (mode === 'login') {
        $authTitle.textContent = 'Iniciar sesión';
        $authSubmit.textContent = 'Ingresar';
        $toggleAuth.textContent = '¿No tienes cuenta? Crear una';
      } else {
        $authTitle.textContent = 'Crear cuenta';
        $authSubmit.textContent = 'Registrarse';
        $toggleAuth.textContent = '¿Ya tienes cuenta? Inicia sesión';
      }
      $authError.textContent = '';
    }
    renderMode();

    $toggleAuth.addEventListener('click', () => {
      mode = (mode === 'login') ? 'register' : 'login';
      renderMode();
    });

    $authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      $authError.textContent = '';
      const email = (document.getElementById('email').value || '').trim();
      const password = document.getElementById('password').value;

      try {
        if (mode === 'login') {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (err) {
        // Mensajes breves y claros
        const map = {
          'auth/invalid-email': 'Correo inválido.',
          'auth/missing-password': 'Ingresa la contraseña.',
          'auth/weak-password': 'Contraseña muy débil (min. 6).',
          'auth/email-already-in-use': 'Ese correo ya está registrado.',
          'auth/invalid-credential': 'Correo o contraseña incorrectos.',
          'auth/operation-not-allowed': 'Habilita Email/Password en Firebase.'
        };
        $authError.textContent = map[err.code] || ('Error: ' + err.message);
      }
    });

    $logoutBtn.addEventListener('click', () => signOut(auth));

    // Mostrar/ocultar app según sesión
    onAuthStateChanged(auth, (user) => {
      const logged = !!user;
      $authSection.classList.toggle('hidden', logged);
      $landing.classList.toggle('hidden', !logged);
      $authBar.classList.toggle('hidden', !logged);
      if (logged) $userEmail.textContent = user.email || user.uid;
    });
  </script>
  <!-- ======================================================================= -->

</body>
</html>
